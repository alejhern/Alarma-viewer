<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alarmas con Checkboxes y Botones</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.7.1/css/buttons.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/colreorder/1.5.0/css/colReorder.dataTables.min.css" />
    <!-- Estilos de ColReorder -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.colVis.min.js"></script>
    <!-- Botón de visibilidad -->
    <script src="https://cdn.datatables.net/colreorder/1.5.0/js/dataTables.colReorder.min.js"></script>
    <!-- Script de ColReorder -->
    <style>
        #alarmasTable {
            margin: 0 auto;
            /* Centra horizontalmente */
            text-align: center;
            /* Centra el contenido del texto en las celdas */
        }
    </style>

</head>

<body>
    <div id="contenedor_buttons" style="margin-bottom: 20px;">
    </div> <!-- Contenedor para el botón de exportación -->
    <table id="alarmasTable" class="display">
        <thead>
            <tr>
                <th id="selectAll-col"><input type="checkbox" class="selectAll" /></th>
                <th>Alarma</th>
                <th>Tag</th>
                <th>Sensor</th>
                <th>Type</th>
                <th>Tiempo</th>
                <th>Última Activación</th>
                <th id="actions-col">Actions</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th><input type="checkbox" class="selectAll" /></th>
                <th>Alarma</th>
                <th>Tag</th>
                <th>Sensor</th>
                <th>Type</th>
                <th>Tiempo</th>
                <th>Última Activación</th>
                <th>Actions</th>
            </tr>
        </tfoot>
    </table>

    <script>
        $(document).ready(function () {
            var table = $("#alarmasTable").DataTable({
                processing: true,
                serverSide: true,
                stateSave: true,  // Activa la opción para guardar automáticamente el estado
                ajax: {
                    url: "./api.php", // Cambia a la URL de tu archivo PHP
                    type: "POST",
                    dataSrc: function (json) {
                        if (json.error) {
                            alert(json.error);
                            return [];
                        }
                        return json.data; // Retornar los datos que se llenarán en la tabla
                    },
                },
                lengthMenu: [10, 25, 50, 100], // Control de "Show entries"
                pageLength: 10, // Valor inicial para mostrar
                colReorder: true, // Permite reordenar columnas
                columns: [
                    { data: null, orderable: false, render: function (data, type, row) { return '<input type="checkbox" class="select-checkbox" value="' + row.codigo_alarma + '">'; } },
                    { data: "codigo_alarma" },
                    { data: "id_tag" },
                    { data: "idSensor" },
                    { data: "type" },
                    { data: "tiempo" },
                    { data: "tiempo_ultima_activacion" },
                    { data: null, orderable: false, render: function (data, type, row) { return '<button class="btn btn-edit" data-id="' + row.codigo_alarma + '">Editar</button> <button class="btn btn-delete" data-id="' + row.codigo_alarma + '">Eliminar</button>'; } }
                ],
                dom: 'lBfrtip', // l: length changing input control, B: buttons, f: filtering input, r: processing display element, t: the table, i: table information summary, p: pagination control
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: 'Exportar a Excel',
                        title: 'Alarmas',
                        exportOptions: {
                            columns: ':visible' // Exportar solo las columnas visibles
                        }
                    },
                    {
                        extend: 'colvis',
                        text: 'Mostrar/Ocultar Columnas',
                        columns: ':not(:last-child)' // Excluir la columna de acciones
                    },
                    {
                        text: 'Guardar Configuración', // Botón personalizado
                        action: function () {
                            var state = table.state();
                            localStorage.setItem('DataTables_alarmasTable', JSON.stringify(state));
                            alert("¡Configuración guardada!");
                        }
                    }
                ]
            });

            // Añadir los botones al contenedor
            table.buttons().container().appendTo('#contenedor_buttons');

            // Cargar configuración guardada al iniciar (si existe)
            var savedState = localStorage.getItem('DataTables_alarmasTable');
            if (savedState) {
                table.state.clear(); // Limpia el estado actual antes de cargar el nuevo
                table.state(JSON.parse(savedState)); // Carga el estado desde localStorage
                table.draw(); // Redibuja la tabla con el estado cargado
            }

            // Seleccionar/desmarcar todos los checkboxes al hacer clic en el checkbox principal
            $(".selectAll").on("click", function () {
                var rows = $("#alarmasTable")
                    .DataTable()
                    .rows({ search: "applied" })
                    .nodes();
                $('input[type="checkbox"]', rows).prop("checked", this.checked);
                $('.selectAll').prop("checked", this.checked);
            });

            // Agregar funcionalidad a los botones de edición y eliminación
            $("#alarmasTable").on("click", ".btn-edit", function () {
                var id = $(this).data("id");
                alert("Editando alarma con ID: " + id);
            });

            $("#alarmasTable").on("click", ".btn-delete", function () {
                var id = $(this).data("id");
                if (confirm("¿Estás seguro de que deseas eliminar la alarma con ID: " + id + "?")) {
                    // Lógica de eliminación
                }
            });
        });
    </script>
</body>

</html>